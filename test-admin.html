<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-dark text-light">
    <div class="container mt-5">
        <h1>üß™ Test Admin Panel</h1>
        
        <!-- Login Form -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header">
                <h5>Login Test</h5>
            </div>
            <div class="card-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label class="form-label">Email:</label>
                        <input type="email" id="loginEmail" class="form-control" value="admin@asm.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password:</label>
                        <input type="password" id="loginPassword" class="form-control" value="admin123">
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
            </div>
        </div>
        
        <!-- User Info -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header">
                <h5>User Info</h5>
            </div>
            <div class="card-body">
                <div id="userInfo">Not logged in</div>
            </div>
        </div>
        
        <!-- Admin Menu Test -->
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-header">
                <h5>Admin Menu Test</h5>
            </div>
            <div class="card-body">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        User Menu
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item" href="#">Profile</a></li>
                        <li><a class="dropdown-item" href="#">Wishlist</a></li>
                        <li><a class="dropdown-item" href="#">Orders</a></li>
                        
                        <!-- Admin Menu (only visible for admin users) -->
                        <li id="admin-menu" style="display:none;">
                            <hr class="dropdown-divider">
                            <a class="dropdown-item text-warning" href="#" onclick="openAdminPanel()">
                                <i class="fas fa-crown me-2"></i>Admin Panel
                            </a>
                        </li>
                        
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()">Logout</a></li>
                    </ul>
                </div>
                <div class="mt-3">
                    <button class="btn btn-info" onclick="testIsAdmin()">Test isAdmin()</button>
                    <button class="btn btn-warning" onclick="testUpdateAdminMenu()">Test updateAdminMenu()</button>
                    <button class="btn btn-success" onclick="openAdminPanel()">Open Admin Panel</button>
                </div>
            </div>
        </div>
        
        <!-- Debug Info -->
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h5>Debug Info</h5>
            </div>
            <div class="card-body">
                <pre id="debugInfo">No debug info yet</pre>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://asm-website-production.up.railway.app';
        const API_ENDPOINTS = {
            LOGIN: `${API_BASE_URL}/api/auth/login`,
            REGISTER: `${API_BASE_URL}/api/auth/register`
        };

        // Utility functions
        function showToast(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        async function apiCall(endpoint, options = {}) {
            const response = await fetch(endpoint, {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP ${response.status}`);
            }

            return response.json();
        }

        // Auth functions
        async function authenticateUser(email, password) {
            try {
                const response = await apiCall(API_ENDPOINTS.LOGIN, {
                    method: 'POST',
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });
                
                return { success: true, user: response.user, token: response.token };
            } catch (error) {
                return { success: false, message: error.message || 'Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!' };
            }
        }

        function getCurrentUser() {
            const user = localStorage.getItem('user');
            if (!user) return null;
            
            try {
                return JSON.parse(user);
            } catch (error) {
                console.error('Error parsing user data:', error);
                return null;
            }
        }

        function isAdmin() {
            const user = getCurrentUser();
            const token = localStorage.getItem('authToken');
            
            if (!user || !token) {
                console.log('üîç Admin Check: No user or token');
                return false;
            }
            
            const isAdminUser = user.isAdmin === true;
            
            console.log('üîç Admin Check:', {
                user: user.email,
                isAdmin: isAdminUser,
                hasToken: !!token,
                userIsAdminField: user.isAdmin,
                userIsAdminType: typeof user.isAdmin
            });
            
            return isAdminUser;
        }

        function updateAdminMenu() {
            const adminMenu = document.getElementById('admin-menu');
            const isAdminUser = isAdmin();
            
            console.log('üîß Update Admin Menu:', {
                adminMenu: adminMenu ? 'Found' : 'Not found',
                isAdmin: isAdminUser,
                display: isAdminUser ? 'block' : 'none'
            });
            
            if (adminMenu) {
                if (isAdminUser) {
                    adminMenu.style.display = 'block';
                    console.log('‚úÖ Admin menu should be visible');
                } else {
                    adminMenu.style.display = 'none';
                    console.log('‚ùå Admin menu should be hidden');
                }
            } else {
                console.log('‚ùå Admin menu element not found');
            }
        }

        function updateUserInfo() {
            const user = getCurrentUser();
            const userInfo = document.getElementById('userInfo');
            
            if (user) {
                userInfo.innerHTML = `
                    <strong>Email:</strong> ${user.email}<br>
                    <strong>Name:</strong> ${user.fullname}<br>
                    <strong>IsAdmin:</strong> ${user.isAdmin}<br>
                    <strong>IsAdmin Type:</strong> ${typeof user.isAdmin}<br>
                    <strong>Has isAdmin field:</strong> ${'isAdmin' in user}<br>
                    <strong>All fields:</strong> ${Object.keys(user).join(', ')}
                `;
            } else {
                userInfo.textContent = 'Not logged in';
            }
        }

        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            const user = getCurrentUser();
            const token = localStorage.getItem('authToken');
            
            debugInfo.textContent = JSON.stringify({
                hasUser: !!user,
                hasToken: !!token,
                user: user,
                isAdminResult: isAdmin(),
                localStorage: {
                    user: localStorage.getItem('user'),
                    token: token ? 'Present' : 'Missing'
                }
            }, null, 2);
        }

        // Test functions
        function testIsAdmin() {
            console.log('üß™ Testing isAdmin()...');
            const result = isAdmin();
            console.log('Result:', result);
            updateDebugInfo();
        }

        function testUpdateAdminMenu() {
            console.log('üß™ Testing updateAdminMenu()...');
            updateAdminMenu();
            updateDebugInfo();
        }

        function openAdminPanel() {
            if (!isAdmin()) {
                showToast('Access denied. Admin privileges required.', 'error');
                return;
            }
            showToast('Admin panel opened!', 'success');
        }

        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('authToken');
            updateUserInfo();
            updateAdminMenu();
            updateDebugInfo();
            showToast('Logged out!', 'info');
        }

        // Event listeners
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            console.log('üîê Attempting login...');
            
            const result = await authenticateUser(email, password);
            
            if (result.success) {
                const user = result.user;
                const token = result.token;
                
                console.log('üîê Login Response:', {
                    user: user,
                    hasIsAdmin: 'isAdmin' in user,
                    isAdminValue: user.isAdmin,
                    isAdminType: typeof user.isAdmin,
                    token: token ? 'Present' : 'Missing'
                });
                
                localStorage.setItem('user', JSON.stringify(user));
                localStorage.setItem('authToken', token);
                
                showToast('Login successful!', 'success');
                
                updateUserInfo();
                updateAdminMenu();
                updateDebugInfo();
            } else {
                showToast(result.message, 'error');
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateUserInfo();
            updateAdminMenu();
            updateDebugInfo();
        });
    </script>
</body>
</html> 